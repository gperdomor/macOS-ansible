---
- name: Ensure ~/.ssh exists
  file:
    path: /Users/{{ ansible_env.USER }}/.ssh
    state: directory
    mode: 0700

- name: Generate ssh keys
  user:
    name: "{{ansible_user}}"
    generate_ssh_key: yes
    ssh_key_bits: 4096
    ssh_key_passphrase: "{{item.passphrase}}"
    ssh_key_file: ".ssh/{{item.name}}"
  items: "{{ssh_keys}}"

- name: Add {{item.host}} ssh config into config file
  blockinfile:
    path: ~/.ssh/config
    create: yes
    backup: yes
    marker: "# {mark} {{ item.name }}"
    content: |
      Host {{item.host}}
       AddKeysToAgent yes
       UseKeychain yes
       IdentityFile ~/.ssh/{{item.name}}
  items: "{{ssh_keys}}"

- name: Enable ssh agent
  shell: eval `ssh-agent -s`

- name: Add ssh private keys to ssh agent
  expect:
    command: "ssh-add -K /Users/{{ansible_user}}/.ssh/{{item.name}}"
    responses:
      (?i)Enter passphrase: "{{item.passphrase}}"
  items: "{{ssh_keys}}"
  tags:
    - skip_ci
